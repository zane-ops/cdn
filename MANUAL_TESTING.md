# Manual Testing Steps

This document outlines the steps to manually test the API endpoints for the Worker + D1 Database project. Replace `YOUR_WORKER_URL` with the actual URL of your deployed worker (e.g., `https://your-worker-name.your-subdomain.workers.dev`) or your local development URL (typically `http://localhost:8787`).

## Prerequisites

*   The worker should be deployed and running.
*   The D1 database should be set up with the necessary schema (`ip_registry`, `ip_pings`).
*   You should have a tool to make HTTP requests (e.g., `curl`, Postman, or a web browser).
*   For endpoints requiring pings, ensure some data has been generated by hitting the `/api/ping` endpoint or `/makefile` from different IP addresses and at different times.

## Endpoints

### 1. `/makefile`

*   **Purpose:** Simulates a client fetching a makefile, and records the client's IP.
*   **Method:** `GET`
*   **URL:** `YOUR_WORKER_URL/makefile`
*   **Verification:**
    *   Response should be the content of the `deploy.mk` file from `https://raw.githubusercontent.com/zane-ops/zane-ops/main/deploy.mk`.
    *   An entry for your IP's HMAC should be created in the `ip_registry` table. If you ping again from the same IP, it should not create a duplicate `ip_hmac`.
    *   A new entry should be created in `ip_pings` for this IP HMAC, unless a ping was recorded from the same IP less than 30 minutes ago.

### 2. `/api/ping`

*   **Purpose:** Records a "ping" from the client's IP address.
*   **Method:** `POST`
*   **URL:** `YOUR_WORKER_URL/api/ping`
*   **Request Body:** None
*   **Verification:**
    *   **Successful Ping:**
        *   Response status: `200 OK`.
        *   Response body: `{"success":true,"message":"Ping recorded successfully"}`.
        *   An entry for your IP's HMAC should be created in the `ip_registry` table (if not already present).
        *   A new entry should be created in the `ip_pings` table with the IP HMAC and current timestamp.
    *   **Ping Too Soon:** If you send another request from the same IP within 30 minutes of a previously recorded ping.
        *   Response status: `200 OK`.
        *   Response body: `{"success":false,"message":"Ping not recorded - less than 30 minutes since last ping"}`.
        *   No new entry should be added to `ip_pings`.

### 3. `/api/pings`

*   **Purpose:** Retrieves a raw list of all recorded pings.
*   **Method:** `GET`
*   **URL:** `YOUR_WORKER_URL/api/pings`
*   **Verification:**
    *   Response status: `200 OK`.
    *   Response body: A JSON array of objects, each with `ip_hmac` and `ping_timestamp`.
    *   Results should be ordered by `ping_timestamp` in descending order.
    *   Example: `[{"ip_hmac":"some_hmac","ping_timestamp":"2023-10-27T10:00:00.000Z"}, ...]`

### 4. `/api/pings/grouped`

*   **Purpose:** Retrieves pings grouped by day, with counts either as unique IPs or total pings for that day.
*   **Method:** `GET`
*   **Base URL:** `YOUR_WORKER_URL/api/pings/grouped`
*   **Query Parameters:**
    *   `period` (optional, default '30d'): '24h', '7d', '30d', '6month', 'all'.
    *   `countType` (optional, default 'unique'): 'unique', 'total'.
*   **Test Cases:**
    *   **Default (30d, unique):** `.../api/pings/grouped`
        *   Verify: Data grouped by day for the last 30 days, count is unique IPs per day.
    *   **24-Hour Period (total):** `.../api/pings/grouped?period=24h&countType=total`
        *   Verify: Data grouped by day for the last 24 hours, count is total pings per day.
    *   **7-Day Period (unique):** `.../api/pings/grouped?period=7d&countType=unique`
        *   Verify: Data grouped by day for the last 7 days, count is unique IPs per day.
    *   **6-Month Period (unique):** `.../api/pings/grouped?period=6month&countType=unique`
        *   Verify: Data grouped by day for the last 6 months, count is unique IPs per day.
    *   **6-Month Period (total):** `.../api/pings/grouped?period=6month&countType=total`
        *   Verify: Data grouped by day for the last 6 months, count is total pings per day.
    *   **All Time (total):** `.../api/pings/grouped?period=all&countType=total`
        *   Verify: Data grouped by day for all recorded pings, count is total pings per day.
*   **Verification (General):**
    *   Response status: `200 OK`.
    *   Response body: A JSON array of objects, each with `day` (YYYY-MM-DD format) and `count` (number).
    *   Results should be ordered by `day` in ascending order.
    *   Example: `[{"day":"2023-10-26","count":5}, {"day":"2023-10-27","count":12}]`

### 5. `/api/stats`

*   **Purpose:** Retrieves the total count of unique IP HMACs in the `ip_registry` table.
*   **Method:** `GET`
*   **URL:** `YOUR_WORKER_URL/api/stats`
*   **Verification:**
    *   Response status: `200 OK`.
    *   Response body: A JSON object with a `total` field.
    *   Example: `{"total":150}`

### 6. `/api/stats/summary`

*   **Purpose:** Retrieves a summary of ping statistics, optionally filtered by a time period.
*   **Method:** `GET`
*   **Base URL:** `YOUR_WORKER_URL/api/stats/summary`
*   **Query Parameters:**
    *   `period` (optional, default 'all'): '24h', '7d', '30d', '6month', 'all'.
*   **Test Cases:**
    *   **Default (all time):** `YOUR_WORKER_URL/api/stats/summary`
        *   Verify: Stats (`totalPings`, `totalUniqueUsers`, `mostActiveUser`) reflect all pings in the database.
    *   **Last 24 hours:** `YOUR_WORKER_URL/api/stats/summary?period=24h`
        *   Verify: Stats are calculated only from pings within the last 24 hours. Compare with data from `/api/pings/grouped?period=24h` if needed.
    *   **Last 7 days:** `YOUR_WORKER_URL/api/stats/summary?period=7d`
        *   Verify: Stats reflect pings from the last 7 days.
    *   **Last 30 days:** `YOUR_WORKER_URL/api/stats/summary?period=30d`
        *   Verify: Stats reflect pings from the last 30 days.
    *   **Last 6 months:** `YOUR_WORKER_URL/api/stats/summary?period=6month`
        *   Verify: Stats reflect pings from the last 6 months.
*   **Verification (General):**
    *   Response status: `200 OK`.
    *   Response body: A JSON object with `totalPings`, `totalUniqueUsers`, and `mostActiveUser` (which can be an object with `ipHmac` and `pingCount`, or `null` if no pings within the period).
    *   Example (with activity for the period): `{"totalPings":123,"totalUniqueUsers":45,"mostActiveUser":{"ipHmac":"some_hmac","pingCount":10}}`
    *   Example (no activity for the period): `{"totalPings":0,"totalUniqueUsers":0,"mostActiveUser":null}`

### 7. `/api/pings/unique-activity`

*   **Purpose:** Retrieves a paginated list of unique IP HMACs with their activity details (first seen, last seen, total pings).
*   **Method:** `GET`
*   **Base URL:** `YOUR_WORKER_URL/api/pings/unique-activity`
*   **Query Parameters:**
    *   `page` (optional, default 1): Page number.
    *   `pageSize` (optional, default 10, max 100): Number of items per page.
    *   `sortBy` (optional, default 'first_seen'): 'first_seen', 'total_pings'.
    *   `sortOrder` (optional, default 'desc'): 'asc', 'desc'.
*   **Test Cases:**
    *   **Default:** `.../api/pings/unique-activity`
        *   Verify: Page 1, 10 items, sorted by first_seen descending.
    *   **Page 2, Size 5:** `.../api/pings/unique-activity?page=2&pageSize=5`
        *   Verify: Page 2, 5 items, sorted by first_seen descending.
    *   **Sort by Total Pings Ascending:** `.../api/pings/unique-activity?sortBy=total_pings&sortOrder=asc`
        *   Verify: Page 1, 10 items, sorted by total_pings ascending.
*   **Verification (General):**
    *   Response status: `200 OK`.
    *   Response body: A JSON object with `data` (array of activity objects) and `pagination` info.
    *   Each object in `data` should have `ip_hmac`, `first_seen`, `last_seen`, `total_pings`.
    *   `pagination` object should include `totalItems`, `currentPage`, `pageSize`, `totalPages`.
    *   Example:
        ```json
        {
          "data": [
            {
              "ip_hmac": "hmac1",
              "first_seen": "2023-10-01T12:00:00.000Z",
              "last_seen": "2023-10-27T10:00:00.000Z",
              "total_pings": 50
            }
          ],
          "pagination": {
            "totalItems": 1,
            "currentPage": 1,
            "pageSize": 10,
            "totalPages": 1
          }
        }
        ```

### 8. `/api/releases` & `/api/latest-release`

*   **Purpose:** Fetch release information from GitHub.
*   **Method:** `GET`
*   **URLs:**
    *   `YOUR_WORKER_URL/api/releases`
    *   `YOUR_WORKER_URL/api/latest-release`
*   **Prerequisites for testing:**
    *   A valid `GITHUB_PAT` secret must be configured for the worker, with permissions to read repository releases.
    *   The target repository (`zane-ops/zane-ops` by default in the code) must have releases.
*   **Verification:**
    *   Response status: `200 OK`.
    *   `/api/releases`: Returns a JSON array of releases, each with `tag` and `url`.
    *   `/api/latest-release`: Returns a JSON object for the latest release, with `tag` and `url`.
    *   CORS headers should be present.

---

Remember to replace placeholders like `YOUR_WORKER_URL` and ensure the environment (database, GitHub PAT) is correctly set up for comprehensive testing.
